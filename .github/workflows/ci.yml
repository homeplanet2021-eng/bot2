name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: horizon
          POSTGRES_USER: horizon
          POSTGRES_PASSWORD: horizon
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U horizon -d horizon"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    env:
      # DB / Redis for async SQLAlchemy
      DATABASE_URL: postgresql+asyncpg://horizon:horizon@localhost:5432/horizon
      REDIS_URL: redis://localhost:6379/0

      # Horizon constants
      ADMIN_TG_IDS: "1375385135"
      HZN_PROFILE_CLASSIC_UUID: "0ffb9199-fd3f-4204-858a-700cab0f9646"
      HZN_PROFILE_PREMIUM_UUID: "d8c73e33-4f4f-4e87-bdbe-ebcbfe2c2c92"

      # Disable external integrations in CI (we only test DB/migrations/seed/imports)
      REMNAWAVE_WEBHOOK_ENABLED: "0"
      NOTIFICATIONS_ENABLED: "0"
      CABINET_ENABLED: "0"

      # Remnawave config still must exist for imports/config
      REMNAWAVE_BASE_URL: "http://localhost"
      REMNAWAVE_API_MODE: "compat"

      # Secret files will be created in a step below
      BOT_TOKEN_FILE: secrets/bot_token
      REMNAWAVE_TOKEN_FILE: secrets/remnawave_token
      REMNAWAVE_WEBHOOK_SECRET_FILE: secrets/remnawave_webhook_secret
      CABINET_JWT_SECRET_FILE: secrets/cabinet_jwt_secret

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create secret files (never printed)
        run: |
          mkdir -p secrets
          umask 077
          printf '%s' "${{ secrets.BOT_TOKEN }}" > secrets/bot_token
          printf '%s' "${{ secrets.REMNAWAVE_TOKEN }}" > secrets/remnawave_token
          # optional secrets: if not set, create non-empty local-only values to satisfy config imports
          if [ -n "${{ secrets.REMNAWAVE_WEBHOOK_SECRET }}" ]; then
            printf '%s' "${{ secrets.REMNAWAVE_WEBHOOK_SECRET }}" > secrets/remnawave_webhook_secret
          else
            python - <<'PY'
import secrets, pathlib
pathlib.Path("secrets/remnawave_webhook_secret").write_text(secrets.token_hex(32))
PY
          fi
          if [ -n "${{ secrets.CABINET_JWT_SECRET }}" ]; then
            printf '%s' "${{ secrets.CABINET_JWT_SECRET }}" > secrets/cabinet_jwt_secret
          else
            python - <<'PY'
import secrets, pathlib
pathlib.Path("secrets/cabinet_jwt_secret").write_text(secrets.token_hex(32))
PY
          fi

      - name: No placeholders gate
        run: |
          rg -n "TODO|TBD|example|placeholder|lorem" -S .

      - name: Wait for Postgres
        run: |
          for i in $(seq 1 60); do
            pg_isready -h localhost -p 5432 -U horizon -d horizon && exit 0
            sleep 1
          done
          echo "Postgres not ready" >&2
          exit 1

      - name: Migrations
        run: |
          alembic upgrade head

      - name: Seed
        run: |
          python -m app.db.seed

      - name: Compile check
        run: |
          python -m compileall -q app

      - name: Import smoke (no network)
        run: |
          python - <<'PY'
import importlib
importlib.import_module("app.api.main")
importlib.import_module("app.bot.main")
importlib.import_module("app.worker.main")
print("imports_ok")
PY
